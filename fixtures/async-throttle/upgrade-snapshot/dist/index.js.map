{"version":3,"file":"index.js","names":["CanceledError","_Error","_inherits2","_super","_createSuper","_this","_classCallCheck2","call","name","_createClass2","_wrapNativeSuper2","Error","exports","Delay","lastInvocationDone","wait","_this2","_defineProperty2","delay","Promise","resolve","timeout","setTimeout","ready","then","key","value","flush","clearTimeout","cancel","canceled","handler","_this3","throttle","fn","_wait","options","arguments","length","undefined","Number","isFinite","Math","max","getNextArgs","prev","next","nextArgs","nextInvocation","invoke","args","reject","result","apply","_toConsumableArray2","setNextArgs","doInvoke","wrapper","_len","Array","_key","error","invokeIgnoreResult","_len2","_key2","err","_asyncToGenerator2","_regenerator","mark","_callee","_delay","_delay$cancel","prevLastInvocationDone","wrap","_callee$","_context","stop","_callee2","_delay2","_delay2$flush","_callee2$","_context2","defaultExport","Object","assign","_default"],"sources":["src/index.js"],"sourcesContent":["// @flow\n\nexport class CanceledError extends Error {\n  constructor() {\n    super('throttled invocation was canceled')\n    this.name = 'CanceledError'\n  }\n}\n\nclass Delay {\n  ready: ?Promise<void>\n  resolve: () => void\n  canceled: boolean = false\n  timeout: TimeoutID\n\n  constructor(lastInvocationDone: Promise<any>, wait: number) {\n    const delay = new Promise((resolve: () => void) => {\n      this.timeout = setTimeout(resolve, wait)\n      this.resolve = resolve\n    })\n    this.ready = lastInvocationDone\n      .then(\n        () => delay,\n        () => delay\n      )\n      .then(() => {\n        this.ready = null\n      })\n  }\n\n  flush() {\n    clearTimeout(this.timeout)\n    this.resolve()\n  }\n\n  cancel() {\n    this.canceled = true\n    clearTimeout(this.timeout)\n    this.resolve()\n  }\n\n  then<T>(handler: () => Promise<T>): Promise<T> {\n    return (this.ready || Promise.resolve()).then((): Promise<T> => {\n      if (this.canceled) throw new CanceledError()\n      return handler()\n    })\n  }\n}\n\ntype $Resolve<V> = $Call<\n  {\n    <V>(Promise<V>): $Resolve<V>,\n    <V>(V): V,\n  },\n  V\n>\n\nexport type ThrottledFunction<Args: Array<any>, Value> = {\n  (...args: Args): Promise<$Resolve<Value>>,\n  invokeIgnoreResult: (...args: Args) => void,\n  cancel: () => Promise<void>,\n  flush: () => Promise<void>,\n}\n\nfunction throttle<Args: Array<any>, Value>(\n  fn: (...args: Args) => Value,\n  _wait: ?number,\n  options: {|\n    getNextArgs?: (args0: Args, args1: Args) => Args,\n  |} = {\n    /* :: ...null */\n  }\n): ThrottledFunction<Args, Value> {\n  const wait = _wait != null && Number.isFinite(_wait) ? Math.max(_wait, 0) : 0\n  const getNextArgs = options.getNextArgs || ((prev, next) => next)\n\n  let nextArgs: ?Args\n  let lastInvocationDone: ?Promise<any> = null\n  let delay: ?Delay = null\n  let nextInvocation: ?Promise<Value> = null\n\n  function invoke(): Promise<Value> {\n    const args = nextArgs\n    // istanbul ignore next\n    if (!args) {\n      return Promise.reject(new Error('unexpected error: nextArgs is null'))\n    }\n    nextInvocation = null\n    nextArgs = null\n    const result = Promise.resolve(fn(...args))\n    lastInvocationDone = result\n      .catch(() => {})\n      .then(() => {\n        lastInvocationDone = null\n      })\n    delay = new Delay(lastInvocationDone, wait)\n    return result\n  }\n\n  function setNextArgs(args: Args) {\n    nextArgs = nextArgs ? getNextArgs(nextArgs, args) : args\n    if (!nextArgs) throw new Error('unexpected error: nextArgs is null')\n  }\n\n  function doInvoke(): Promise<Value> {\n    return (nextInvocation = (delay || Promise.resolve()).then(invoke))\n  }\n  function wrapper(...args: Args): Promise<Value> {\n    try {\n      setNextArgs(args)\n    } catch (error) {\n      return Promise.reject(error)\n    }\n    return nextInvocation || doInvoke()\n  }\n\n  /**\n   * Calls the throttled function soon, but doesn't return a promise, catches\n   * any CanceledError, and doesn't create any new promises if a call is already\n   * pending.\n   *\n   * The throttled function should handle all errors internally,\n   * e.g.:\n   *\n   * asyncThrottle(async () => {\n   *   try {\n   *     await foo()\n   *   } catch (err) {\n   *     // handle error\n   *   }\n   * })\n   *\n   * If the throttled function throws an error or returns a promise that is\n   * eventually rejected, the runtime's unhandled promise rejection handler will\n   * be called, which may crash the process, route the rejection to a handler\n   * that has been previously registered, or ignore the rejection, depending\n   * on the runtime and your code.\n   */\n  wrapper.invokeIgnoreResult = (...args: Args) => {\n    setNextArgs(args)\n    if (!nextInvocation) {\n      doInvoke().catch((err: any) => {\n        if (!(err instanceof CanceledError)) {\n          // trigger the unhandled promise rejection handler\n          throw err\n        }\n      })\n    }\n  }\n\n  wrapper.cancel = async (): Promise<void> => {\n    const prevLastInvocationDone = lastInvocationDone\n    delay?.cancel?.()\n    nextInvocation = null\n    nextArgs = null\n    lastInvocationDone = null\n    delay = null\n    await prevLastInvocationDone\n  }\n\n  wrapper.flush = async (): Promise<void> => {\n    delay?.flush?.()\n    await lastInvocationDone\n  }\n\n  return wrapper\n}\n\nconst defaultExport: {|\n  <Args: Array<any>, Value>(\n    fn: (...args: Args) => Value,\n    wait: ?number,\n    options?: {|\n      getNextArgs?: (args0: Args, args1: Args) => Args,\n    |}\n  ): ThrottledFunction<Args, Value>,\n|} = Object.assign(throttle, { CanceledError })\n\nexport default defaultExport\n"],"mappings":"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"}
