{"version":3,"file":"index.js","names":["CanceledError","Error","constructor","name","exports","Delay","canceled","lastInvocationDone","wait","delay","Promise","resolve","timeout","setTimeout","ready","then","flush","clearTimeout","cancel","handler","throttle","fn","_wait","options","Number","isFinite","Math","max","getNextArgs","prev","next","nextArgs","nextInvocation","invoke","args","reject","result","catch","setNextArgs","doInvoke","wrapper","error","invokeIgnoreResult","err","_delay","_delay$cancel","prevLastInvocationDone","call","_delay2","_delay2$flush","defaultExport","Object","assign","_default","default"],"sources":["src/index.js"],"sourcesContent":["// @flow\n\nexport class CanceledError extends Error {\n  constructor() {\n    super('throttled invocation was canceled')\n    this.name = 'CanceledError'\n  }\n}\n\nclass Delay {\n  ready: ?Promise<void>\n  resolve: () => void\n  canceled: boolean = false\n  timeout: TimeoutID\n\n  constructor(lastInvocationDone: Promise<any>, wait: number) {\n    const delay = new Promise((resolve: () => void) => {\n      this.timeout = setTimeout(resolve, wait)\n      this.resolve = resolve\n    })\n    this.ready = lastInvocationDone\n      .then(\n        () => delay,\n        () => delay\n      )\n      .then(() => {\n        this.ready = null\n      })\n  }\n\n  flush() {\n    clearTimeout(this.timeout)\n    this.resolve()\n  }\n\n  cancel() {\n    this.canceled = true\n    clearTimeout(this.timeout)\n    this.resolve()\n  }\n\n  then<T>(handler: () => Promise<T>): Promise<T> {\n    return (this.ready || Promise.resolve()).then((): Promise<T> => {\n      if (this.canceled) throw new CanceledError()\n      return handler()\n    })\n  }\n}\n\ntype $Resolve<V> = $Call<\n  {\n    <V>(Promise<V>): $Resolve<V>,\n    <V>(V): V,\n  },\n  V,\n>\n\nexport type ThrottledFunction<Args: Array<any>, Value> = {\n  (...args: Args): Promise<$Resolve<Value>>,\n  invokeIgnoreResult: (...args: Args) => void,\n  cancel: () => Promise<void>,\n  flush: () => Promise<void>,\n}\n\nfunction throttle<Args: Array<any>, Value>(\n  fn: (...args: Args) => Value,\n  _wait: ?number,\n  options: {|\n    getNextArgs?: (args0: Args, args1: Args) => Args,\n  |} = { ...null }\n): ThrottledFunction<Args, Value> {\n  const wait = _wait != null && Number.isFinite(_wait) ? Math.max(_wait, 0) : 0\n  const getNextArgs = options.getNextArgs || ((prev, next) => next)\n\n  let nextArgs: ?Args\n  let lastInvocationDone: ?Promise<any> = null\n  let delay: ?Delay = null\n  let nextInvocation: ?Promise<Value> = null\n\n  function invoke(): Promise<Value> {\n    const args = nextArgs\n    // istanbul ignore next\n    if (!args) {\n      return Promise.reject(new Error('unexpected error: nextArgs is null'))\n    }\n    nextInvocation = null\n    nextArgs = null\n    const result = Promise.resolve(fn(...args))\n    lastInvocationDone = result\n      .catch(() => {})\n      .then(() => {\n        lastInvocationDone = null\n      })\n    delay = new Delay(lastInvocationDone, wait)\n    return result\n  }\n\n  function setNextArgs(args: Args) {\n    nextArgs = nextArgs ? getNextArgs(nextArgs, args) : args\n    if (!nextArgs) throw new Error('unexpected error: nextArgs is null')\n  }\n\n  function doInvoke(): Promise<Value> {\n    return (nextInvocation = (delay || Promise.resolve()).then(invoke))\n  }\n  function wrapper(...args: Args): Promise<Value> {\n    try {\n      setNextArgs(args)\n    } catch (error) {\n      return Promise.reject(error)\n    }\n    return nextInvocation || doInvoke()\n  }\n\n  /**\n   * Calls the throttled function soon, but doesn't return a promise, catches\n   * any CanceledError, and doesn't create any new promises if a call is already\n   * pending.\n   *\n   * The throttled function should handle all errors internally,\n   * e.g.:\n   *\n   * asyncThrottle(async () => {\n   *   try {\n   *     await foo()\n   *   } catch (err) {\n   *     // handle error\n   *   }\n   * })\n   *\n   * If the throttled function throws an error or returns a promise that is\n   * eventually rejected, the runtime's unhandled promise rejection handler will\n   * be called, which may crash the process, route the rejection to a handler\n   * that has been previously registered, or ignore the rejection, depending\n   * on the runtime and your code.\n   */\n  wrapper.invokeIgnoreResult = (...args: Args) => {\n    setNextArgs(args)\n    if (!nextInvocation) {\n      doInvoke().catch((err: any) => {\n        if (!(err instanceof CanceledError)) {\n          // trigger the unhandled promise rejection handler\n          throw err\n        }\n      })\n    }\n  }\n\n  wrapper.cancel = async (): Promise<void> => {\n    const prevLastInvocationDone = lastInvocationDone\n    delay?.cancel?.()\n    nextInvocation = null\n    nextArgs = null\n    lastInvocationDone = null\n    delay = null\n    await prevLastInvocationDone\n  }\n\n  wrapper.flush = async (): Promise<void> => {\n    delay?.flush?.()\n    await lastInvocationDone\n  }\n\n  return wrapper\n}\n\nconst defaultExport: {|\n  <Args: Array<any>, Value>(\n    fn: (...args: Args) => Value,\n    wait: ?number,\n    options?: {|\n      getNextArgs?: (args0: Args, args1: Args) => Args,\n    |}\n  ): ThrottledFunction<Args, Value>,\n|} = Object.assign(throttle, { CanceledError })\n\nexport default defaultExport\n"],"mappings":"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","ignoreList":[]}
