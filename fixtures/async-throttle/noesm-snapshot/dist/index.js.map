{"version":3,"file":"index.js","names":["CanceledError","Error","constructor","name","Delay","canceled","lastInvocationDone","wait","delay","Promise","resolve","timeout","setTimeout","ready","then","flush","clearTimeout","cancel","handler","throttle","fn","_wait","options","Number","isFinite","Math","max","getNextArgs","prev","next","nextArgs","nextInvocation","invoke","args","result","catch","wrapper","prevLastInvocationDone","_default","exports","default","module"],"sources":["src/index.js"],"sourcesContent":["// @flow\n\nclass CanceledError extends Error {\n  constructor() {\n    super('throttled invocation was canceled')\n    this.name = 'CanceledError'\n  }\n}\n\nclass Delay {\n  ready: Promise<void>\n  resolve: () => void\n  canceled: boolean = false\n  timeout: TimeoutID\n\n  constructor(lastInvocationDone: Promise<any>, wait: number) {\n    const delay = new Promise((resolve: () => void) => {\n      this.timeout = setTimeout(resolve, wait)\n      this.resolve = resolve\n    })\n    this.ready = lastInvocationDone.then(\n      () => delay,\n      () => delay\n    )\n  }\n\n  flush() {\n    clearTimeout(this.timeout)\n    this.resolve()\n  }\n\n  cancel() {\n    this.canceled = true\n    clearTimeout(this.timeout)\n    this.resolve()\n  }\n\n  then<T>(handler: () => Promise<T>): Promise<T> {\n    return this.ready.then((): Promise<T> => {\n      if (this.canceled) throw new CanceledError()\n      return handler()\n    })\n  }\n}\n\nfunction throttle<Args: Array<any>, Value>(\n  fn: (...args: Args) => Value | Promise<Value>,\n  _wait: ?number,\n  options: {\n    getNextArgs?: (args0: Args, args1: Args) => Args,\n  } = {}\n): {\n  (...args: Args): Promise<Value>,\n  cancel: () => Promise<void>,\n  flush: () => Promise<void>,\n} {\n  const wait = _wait != null && Number.isFinite(_wait) ? Math.max(_wait, 0) : 0\n  const getNextArgs = options.getNextArgs || ((prev, next) => next)\n\n  let nextArgs: ?Args\n  let lastInvocationDone: Promise<any> = Promise.resolve()\n  let delay: Delay = new Delay(lastInvocationDone, 0)\n  let nextInvocation: ?Promise<Value> = null\n\n  function invoke(): Promise<Value> {\n    const args = nextArgs\n    // istanbul ignore next\n    if (!args) throw new Error('unexpected error: nextArgs is null')\n    nextInvocation = null\n    nextArgs = null\n    const result = (async () => await fn(...args))()\n    lastInvocationDone = result.catch(() => {})\n    delay = new Delay(lastInvocationDone, wait)\n    return result\n  }\n\n  function wrapper(...args: Args): Promise<Value> {\n    nextArgs = nextArgs ? getNextArgs(nextArgs, args) : args\n    if (!nextArgs) throw new Error('unexpected error: nextArgs is null')\n    if (!nextInvocation) nextInvocation = delay.then(invoke)\n    return nextInvocation\n  }\n\n  wrapper.cancel = async (): Promise<void> => {\n    const prevLastInvocationDone = lastInvocationDone\n    delay.cancel()\n    nextInvocation = null\n    nextArgs = null\n    lastInvocationDone = Promise.resolve()\n    delay = new Delay(lastInvocationDone, 0)\n    await prevLastInvocationDone\n  }\n\n  wrapper.flush = async (): Promise<void> => {\n    delay.flush()\n    await lastInvocationDone\n  }\n\n  return wrapper\n}\n;(throttle: any).CanceledError = CanceledError\n\nexport default ((throttle: any): {\n  <Args: Array<any>, Value>(\n    fn: (...args: Args) => Promise<Value>,\n    wait: ?number,\n    options?: {\n      getNextArgs?: (args0: Args, args1: Args) => Args,\n    }\n  ): {\n    (...args: Args): Promise<Value>,\n    cancel: () => Promise<void>,\n    flush: () => Promise<void>,\n  },\n  CanceledError: typeof CanceledError,\n})\n"],"mappings":"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","ignoreList":[]}
